<link rel="stylesheet/less" type="text/css" media="screen" th:href="@{/css/jquery.dynatable.css}"  th:fragment="css" />

<div id="pageListeContacts" class="container main_content" th:fragment="content">

	<h2>Liste de vos contacts :</h2>
	<p class="instructions">Consultez et gérez tous vos contacts.</p>
	
	<p id="lienAjouter"><a th:href="@{'/modifier-contact/0'}" title="Ajouter un contact"><span class="glyphicon glyphicon-plus-sign"></span>Ajouter un contact</a></p>
	
	<div id="listeContacts">
		<form id="formRecherche" class="form-horizontal">
			<div class="form-group">
				<label for="inputSearch" class="col-xs-12 col-sm-4 col-md-4 col-lg-4 control-label">Recherche</label>
				<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6 ">	
					<input type="text" id="inputSearch" class="form-control fuzzy-search" />
				</div>
			</div>
			<div class="form-group">
				<label class="col-xs-12 col-sm-4 col-md-4 col-lg-4 control-label">Tri</label>
				<div id="boutonsTri" class="btn-group col-xs-12 col-sm-6 col-md-6 col-lg-6" role="group" ></div>
			</div>
		</form>
		<div class="list">
			<div th:id="${c.idcontactEncrypt}" class="contact col-xs-12 col-sm-4 col-md-4 col-lg-4" th:each="c,stat :${contacts}">
				<div class="media">
					<div class="avatar media-left">
						<p class="favori">
							<span th:if="${c.favoris} == true" class="link glyphicon glyphicon-star"></span>
							<span th:if="${c.favoris} == false" class="link glyphicon glyphicon-star-empty"></span>
							<span th:text="${c.favoris}" class="hidden"></span>
						</p>
						<img th:if="${d.datatype} == 'PHOTO'" th:src="@{'/imgs/avatar/'+${c.idcontactEncrypt}+'/'+${d.valeur}}" th:each="d :${contacts[__${stat.index}__].donnees}" />
					</div>
					<div class="media-body">
						<span class="hidden" th:if="${d.accueil}" th:text="${d.libellechamp}" th:each="d :${contacts[__${stat.index}__].donnees}"></span>
						<p th:class="'info'+${d.idchamp}" th:if="${d.accueil}" th:text="${d.valeur}" th:each="d :${contacts[__${stat.index}__].donnees}"></p>
					</div>
					<div class="boutons_mod_sup">
						<a th:href="@{'/modifier-contact/'+${c.idcontactEncrypt}}" title="Modifier le contact">
							<span class="glyphicon glyphicon-edit"></span>
						</a>
						<span class="supprimer_contact">
							<span class="link glyphicon glyphicon-trash"></span>
						</span>
					</div>
				</div>
			</div>			
		</div>
	</div>
</div>

<script type="text/javascript" th:src="@{/js/List.min.js}" th:fragment="javascript"></script>
<script th:fragment="javascript">

	jQuery(document).ready(function() {
		// Récupération des classes pour le filtre
		var classes = new Array();
		classes.push("favori");
		$(".media-body").first().children("p").each(function(){
			classes.push($(this).attr("class"));
		});
		
		var libelles = new Array();
		libelles.push("Favoris");
		$(".media-body").first().children("span.hidden").each(function(){
			libelles.push($(this).text());
		});
		
		// Récupération des libellés pour le tri
		$.each(libelles, function(index, value) {
			$("#boutonsTri").append('<button type="button" class="sort btn btn-default" data-sort="' + classes[index] + '">' + value + '</button>');
		});
		
		options = { valueNames : classes };
		var contactsList = new List('listeContacts', options);
		contactsList.sort('favori', {
			  order: 'desc'
		})
		
		// Supprimer un contact
		$(".supprimer_contact").click(function() {
			if (confirm("Voulez-vous supprimer ce contact ?")) {
				$.ajax({
					context: this,
					url: '/supprimer-contact/' + $(this).parents(".contact").attr("id"),
					type: 'GET',
					success: function(res) {
						if (res == true) {
							$(this).parents(".contact").hide();
						}
					}
				});
			}
		});
		
		// Changer le statut favori
		$(".favori").click(function() {
			$.ajax({
				context: this,
				url: '/changer-favori/' + $(this).parents(".contact").attr("id") + "/" + $(this).children(".hidden").text(),
				type: 'GET',
				success: function(res) {
					if (res == true) {
						if ($(this).children(".hidden").text() == "false") {
							$(this).children(".hidden").text("true");
							$(this).children(".link").replaceWith('<span class="link glyphicon glyphicon-star"></span>');
						} else {
							$(this).children(".hidden").text("false");
							$(this).children(".link").replaceWith('<span class="link glyphicon glyphicon-star-empty"></span>');
						}
					}
				}
			});
		});		
		
		// Ajout de la photo de profil par défaut
		$('.avatar').each(function() {
		    if ($(this).find('img').length == 0) {
		    	$('<img th:src="@{/imgs/default-avatar.png}" title="Photo de profil" />').appendTo(this);
		    }
		});
		
		var nbContacts = 0;
		$('.contact').each(function() {
			nbContacts++;			
		});
		if (nbContacts == 0) {
			$('.list').append('<p id="pasContacts">Vous n\'avez pas encore de contacts, n\'hésitez pas à en créer !</p>');
			$('#formRecherche').hide();
		}
	});
</script>